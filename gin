#!/bin/bash

# Input
################################################################################

# Variables
########################################

# Default Variables
HOME=~
FULL="`readlink -f $0`"  # The full path to this script (basepath)
BASE="`basename $0`"
DATE="`date +%F`"

# Backup Variables
VBND="$BASE/$DATE"
DBMN="$HOME/backups/$VBND"

# Working Variables
DWMN="/tmp/$VBND"
FWTO="$DWMN/tempone.tmp"
FWTT="$DWMN/temptwo.tmp"

# Custom Variables
LPFR='<Hostname> <User> <Port> <PrivateSSHKeyFilePath> <OptionalComments>'
FPLS="$HOME/.gin.txt"

# Functions
########################################

# Display help text
f_hlp () { echo "
DESCRIPTION:
  This script types out ssh commands for you and executes them.
  GIN stands for \"Get IN\".

SYNTAX:
  # $BASE [OPTIONS]

OPTIONS:
  -h, --help
    Displays this help text.
  -r, --run
    Run/execute this script
  -l, --list
    List the reference file contents
  -f, -g, --filter, --grep
    Filter a string from the reference file (grep)
  -e, --edit
    Edit the reference file

NOTES:
  Reference/List File
    The reference file is used to populate the hostname list at the second prompt:
      $FPLS
    The reference file requires 4 sections in it (separated by spaces):
      $LPFR
" ; exit ; }

# Print error message & help text
f_errr () { echo ;echo "!!! ERROR: $1 !!!" ;f_hlp ; }

# simply display the contents of the list file
f_list () { cat $FPLS ; }

# filter the contents of the list file with the provided string
f_grep () { 
	if [[ -z "$VWST" ]] ;then
		f_errr "String is empty." ;fi
	grep "$VWST" $FPLS ; }

# set editor and edit list file
f_edit () {
  if [[ -z $VWED ]] ;then
    if [[ `which vim` ]] ;then VWED='vim'
    elif [[ `which nano` ]] ;then VWED='nano'
    elif [[ `which emacs` ]] ;then VWED='emacs'
    else VWED='vi' ;fi
  fi
  echo "Editor is: `which $VWED`"
  $VWED $FPLS
  exit ; }

# SSH into server
f_run () {

  # first prompt: filter list
  clear ;read -p "
Enter a string to filter the hostname list (case-insensitive grep).
To view all hosts, leave blank and hit \"Enter\".
[selection]: " VWSL

  CWLO=`grep -i "$VWSL" $FPLS`

  # second prompt: selection
  VWCN=`echo "$CWLO" |wc -l |xargs`
  CWLN=`echo "$CWLO" |sort |cat -n |column -t`

  read -p "
`echo "$CWLN" |column -t`

Which server do you want to log into?
[1-$VWCN, (q)uit]: " VWSL

  # error checking
  if [[ $VWSL == q ]] || [[ $VWSL == quit ]] ;then
    echo "Exiting..." ;exit
  elif [[ $VWSL -lt 1 ]] || [[ $VWSL -gt $VWCN ]] ;then
    echo "Error: invalid selection" ;exit ;fi

  # set variables
  HOST=`echo "$CWLN" |grep "^$VWSL\ " |awk '{print $2}' |awk '{print $1}'`
  USER=`echo "$CWLN" |grep "^$VWSL\ " |awk '{print $3}' |awk '{print $1}'`
  PORT=`echo "$CWLN" |grep "^$VWSL\ " |awk '{print $4}' |awk '{print $1}'`
  KEY=`echo "$CWLN" |grep "^$VWSL\ " |awk '{print $5}' |awk '{print $1}'`
  NOTE=`echo "$CWLN" |grep "^$VWSL\ " |awk '{$1=$2=$3=$4=$5="" ;print $0}' |awk '{print $1}'`

  # ssh into server
  echo "
HOST=$HOST
USER=$USER
PORT=$PORT
KEY=$KEY
NOTE=$NOTE

ssh -p $PORT -i $KEY $USER@$HOST

"
  ssh -p $PORT -i $KEY $USER@$HOST ; }

# Arguments
########################################

# Filter Options
if [[ "$#" < 1 ]] ;then f_hlp ;fi
VWCN=0
while (( "$#" > 0 )) ;do
  VWCN=$((VWCN + 1))
  if [[ $VWCN > 99 ]] ;then f_errr "Script is looping" ;fi
  case $1 in
    '-h'|'--help')  HELP='true' ;shift  ;;
    '-r'|'--run')  RUN='true' ;shift  ;;
    '-l'|'--list')  LIST='true' ;shift ;;
    '-f'|'-g'|'--filter'|'--grep')  GREP='true' ;VWST="$2" ;shift ;shift ;;
    '-e'|'--edit')  EDIT='true' ;shift ;;
    *)  f_errr "Invalid argument(s)"  ;;
  esac ;done

# Processing
################################################################################

# Error Checks
########################################

# Check for Help
if [[ $HELP == 'true' ]] ;then f_hlp ;fi

# list file exists
if [[ ! -f $FPLS ]] ;then echo "$LPFR" > $FPLS ;fi

# Script Start
########################################

# fix list file permissions
chmod 640 $FPLS

# sort file contents
sort -o $FPLS $FPLS

# Process Options
if [[ $LIST == 'true' ]] ;then f_list ;fi
if [[ $EDIT == 'true' ]] ;then f_edit ;fi
if [[ $GREP == 'true' ]] ;then f_grep ;fi
if [[ $RUN == 'true' ]] ;then f_run ;fi

# Output
################################################################################

